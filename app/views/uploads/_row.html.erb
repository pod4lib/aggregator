<% if can?(:read, upload) && upload.url.present? && upload.files.none? %>
  <tr>
    <td class="text-center"><i class="bi bi-arrow-repeat pod-icon"></i></td>
    <td>
      <i>Downloading...</i>
    </td>
    <td><%= local_time(upload.created_at, format: datetime_display_format()) %></td>
    <td class="text-end">-</td>
    <td>-</td>
    <td class="text-end">-</td>
    <td><%= link_to 'Source ðŸ”—', upload.url, title: upload.url %></td>
  </tr>
<% end %>
<% if upload.status == 'compacted' %>
  <tr>
    <td class="align-middle text-center">
      <i class="<%= Settings.upload_status.unknown.icon_class %> pod-metadata-status" aria-label=""></i>
    </td>
    <td class="align-middle"><strong>Compacted uploads:</strong></td>
    <td class="align-middle"><%= local_time(upload.created_at, format: datetime_display_format()) %></td>
    <td class="align-middle text-end"><%= number_to_human_size upload.compacted_uploads.sum(:total_byte_size) %></td>
    <td class="align-middle">-</td>
    <td class="align-middle text-end">-</td>
    <td class="align-middle text-center">
      <%= link_to organization_upload_path(@organization, upload), class: 'btn btn-sm btn-secondary' do %>
        <i class="bi bi-folder2-open pod-icon" aria-label="Show"></i>
      <% end %>
    </td>
  </tr>
  <% upload.compacted_uploads.each do |u| %>
    <%= render 'uploads/row', upload: u %>
  <% end %>
<% end %>

<tr data-turbo="false">
  <td class="align-middle text-center">
    <%= render(StatusIcons::UploadStatusIconComponent.new(status: upload.metadata_status)) %>
  </td>
  <td class="align-middle">
    <% if upload.files.one? %>
      <% file = upload.files.first %>
      <%= link_to_if can?(:read, upload), file.filename, download_url(file), title: "Download #{file.filename}" %>
    <% elsif upload.files.any? %>
      <%= upload.files.count %> files:

      <% upload.files.each do |file| %>
        <%= link_to_if can?(:read, upload), file.filename, download_url(file), title: "Download #{file.filename}" %>
      <% end %>
    <% end %>
  </td>
  <td class="align-middle"><%= local_time(upload.created_at, format: datetime_display_format()) %></td>
  <td class="align-middle text-end"><%= number_to_human_size upload.total_byte_size %></td>
  <td class="align-middle"><%= upload.content_type %></td>
  <td class="align-middle text-end">
    <span class="text-success"><%= "+#{upload.marc_records_count}" if upload.marc_records_count.positive? %></span>
    <span class="text-danger"><%= "-#{upload.deletes_count}" if upload.deletes_count&.positive? %></span>
  </td>
  <td class="align-middle text-center text-nowrap">
    <% if can? :read, upload %>
      <% if upload.files.one? %>
        <% file = upload.files.first %>
        <%= link_to file_info_organization_upload_path(@organization, upload, file), class: 'btn btn-sm btn-secondary' do %>
          <i class="bi bi-file-earmark pod-icon" title="MARC records"></i>
        <% end %>
      <% else %>
        <%= link_to organization_upload_path(@organization, upload), class: 'btn btn-sm btn-secondary' do %>
          <i class="bi bi-folder2-open pod-icon" title="Files"></i>
        <% end %>
      <% end %>
      <% if upload.url.present? %>
        <%= link_to 'Source ðŸ”—', upload.url, title: upload.url, class: 'btn btn-sm btn-link' %>
      <% end %>
    <% end %>
    <% if can? :manage, Upload %>
      <span class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle ps-2" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          <span class="visually-hidden">More options</span>
        </button>
        <ul class="dropdown-menu">
          <li><%= link_to 'Delete', [@organization, upload], data: { turbo_method: :delete, turbo_confirm: 'Are you sure?' }, class: 'dropdown-item' if can? :destroy, upload %></li>
        </ul>
      </span>
    <% end %>
  </td>
</tr>
